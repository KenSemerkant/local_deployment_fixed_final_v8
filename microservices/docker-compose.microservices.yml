version: '3.8'

services:
  # API Gateway
  gateway:
    build:
      context: ./microservices/gateway
      dockerfile: Dockerfile
    ports:
      - "3000:80"   # Frontend
      - "8000:8000" # API Gateway
    depends_on:
      - auth-service
      - document-service
      - llm-service
      - analytics-service
      - storage-service
    restart: unless-stopped

  # Authentication Service
  auth-service:
    build:
      context: ./microservices/auth-service
      dockerfile: Dockerfile
    expose:
      - "8001"
    environment:
      - DATABASE_URL=sqlite:////data/db/auth.db
      - JWT_SECRET=${JWT_SECRET:-my-secret-key}
      - REDIS_URL=redis://redis:6379
    volumes:
      - auth_data:/data
    restart: unless-stopped

  # Document Processing Service
  document-service:
    build:
      context: ./microservices/document-service
      dockerfile: Dockerfile
    expose:
      - "8002"
    environment:
      - DATABASE_URL=sqlite:////data/db/documents.db
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=false
      - DOCUMENTS_BUCKET=documents
      - STORAGE_PATH=/data
      - REDIS_URL=redis://redis:6379
    volumes:
      - document_data:/data
    depends_on:
      - minio
    restart: unless-stopped

  # LLM Integration Service
  llm-service:
    build:
      context: ./microservices/llm-service
      dockerfile: Dockerfile
    expose:
      - "8003"
    environment:
      - LLM_MODE=${LLM_MODE:-mock}
      - MOCK_DELAY=${MOCK_DELAY:-2}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-http://host.docker.internal:1234/v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-lm-studio}
      - OPENAI_MODEL=${OPENAI_MODEL:-mistralai/magistral-small-2509}
      - REDIS_URL=redis://redis:6379
      - STORAGE_PATH=/data
      - ENABLE_CACHING=${ENABLE_CACHING:-true}
    volumes:
      - llm_data:/data
    restart: unless-stopped

  # Analytics Service
  analytics-service:
    build:
      context: ./microservices/analytics-service
      dockerfile: Dockerfile
    expose:
      - "8004"
    environment:
      - DATABASE_URL=sqlite:////data/db/analytics.db
      - REDIS_URL=redis://redis:6379
    volumes:
      - analytics_data:/data
    restart: unless-stopped

  # Storage Management Service
  storage-service:
    build:
      context: ./microservices/storage-service
      dockerfile: Dockerfile
    expose:
      - "8005"
    environment:
      - STORAGE_PATH=/data/storage
      - DATABASE_URL=sqlite:////data/db/storage.db
      - REDIS_URL=redis://redis:6379
    volumes:
      - storage_data:/data
    restart: unless-stopped

  # Storage (MinIO)
  minio:
    image: minio/minio
    expose:
      - "9000"
      - "9001"
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    restart: unless-stopped

  # Redis (for caching and session management)
  redis:
    image: redis:7-alpine
    expose:
      - "6379"
    restart: unless-stopped

volumes:
  auth_data:
  document_data:
  llm_data:
  analytics_data:
  storage_data:
  minio_data:

networks:
  default:
    driver: bridge
    name: ai_financial_analyst_network